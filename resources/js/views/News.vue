<template>
  <div class="container all_menu">
    <div class="block menu">
      <ul>
        <li>
          <svg
            width="35px"
            height="35px"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <g id="SVGRepo_iconCarrier">
              <path
                d="M8 10.5H16M8 14.5H11M21.0039 12C21.0039 16.9706 16.9745 21 12.0039 21C9.9675 21 3.00463 21 3.00463 21C3.00463 21 4.56382 17.2561 3.93982 16.0008C3.34076 14.7956 3.00391 13.4372 3.00391 12C3.00391 7.02944 7.03334 3 12.0039 3C16.9745 3 21.0039 7.02944 21.0039 12Z"
                stroke="#585858"
                stroke-width="1.4"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path>
            </g>
          </svg>
          Сообщения
        </li>
        <li>
          <svg
            width="35"
            height="35"
            viewBox="0 0 38 35"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M13.7009 16.45C16.1396 16.45 18.1165 14.6112 18.1165 12.343C18.1165 10.0747 16.1396 8.23593 13.7009 8.23593C11.2622 8.23593 9.28522 10.0747 9.28522 12.343C9.28522 14.6112 11.2622 16.45 13.7009 16.45Z"
              stroke="#585858"
              stroke-width="2"
            />
            <path
              d="M26.4157 18.2141C28.8544 18.2141 30.8313 16.3753 30.8313 14.107C30.8313 11.8388 28.8544 10 26.4157 10C23.977 10 22 11.8388 22 14.107C22 16.3753 23.977 18.2141 26.4157 18.2141Z"
              stroke="#585858"
              stroke-width="2"
            />
            <path
              d="M22.6204 27.3109C22.6204 26.2189 22.389 25.1375 21.9395 24.1286C21.49 23.1197 20.8312 22.2031 20.0007 21.4312C19.1701 20.6592 18.1842 20.047 17.0992 19.6296C16.0143 19.2122 14.8515 18.9977 13.6773 18.9984C11.3071 18.9984 9.03385 19.8742 7.35781 21.4331C5.68176 22.992 4.74017 25.1063 4.74017 27.3109H22.6204Z"
              stroke="#585858"
              stroke-width="2"
            />
            <path
              d="M25.2075 27.3109H33.439C33.4391 26.4305 33.2523 25.5587 32.8895 24.7455C32.5268 23.9324 31.9951 23.1937 31.3249 22.5719C30.6548 21.9501 29.8593 21.4574 28.9841 21.122C28.109 20.7866 27.1712 20.615 26.2246 20.6172C25.0458 20.6157 23.8846 20.8843 22.8438 21.3992"
              stroke="#585858"
              stroke-width="2"
            />
          </svg>
          Друзья
        </li>
        <li>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="35"
            height="35"
            viewBox="0 0 38 35"
            fill="none"
          >
            <g clip-path="url(#clip0_3_25)">
              <path
                d="M18.2002 16.4459C20.3624 16.4459 22.1152 14.8319 22.1152 12.8409C22.1152 10.8499 20.3624 9.23593 18.2002 9.23593C16.038 9.23593 14.2852 10.8499 14.2852 12.8409C14.2852 14.8319 16.038 16.4459 18.2002 16.4459Z"
                stroke="#585858"
                stroke-width="2"
              />
              <path
                d="M29.4157 18.2141C31.8544 18.2141 33.8313 16.3753 33.8313 14.107C33.8313 11.8388 31.8544 10 29.4157 10C26.977 10 25 11.8388 25 14.107C25 16.3753 26.977 18.2141 29.4157 18.2141Z"
                stroke="#585858"
                stroke-width="2"
              />
              <path
                d="M25.6202 27.3109C25.6202 26.2189 25.4276 25.1375 25.0536 24.1286C24.6795 23.1197 24.1312 22.2031 23.44 21.4312C22.7489 20.6592 21.9284 20.047 21.0255 19.6296C20.1225 19.2122 19.1549 18.9977 18.1777 18.9984C16.2052 18.9984 14.3134 19.8742 12.9186 21.4331C11.5238 22.992 10.7402 25.1063 10.7402 27.3109H25.6202Z"
                stroke="#585858"
                stroke-width="2"
              />
              <path
                d="M28.2075 27.3109H36.439C36.4391 26.4305 36.2523 25.5587 35.8895 24.7455C35.5268 23.9324 34.9951 23.1937 34.3249 22.5719C33.6548 21.9501 32.8593 21.4574 31.9841 21.122C31.109 20.7866 30.1712 20.615 29.2246 20.6172C28.0458 20.6157 26.8846 20.8843 25.8438 21.3992"
                stroke="#585858"
                stroke-width="2"
              />
              <path
                d="M7.4131 18.6141C9.8518 18.6141 11.8288 16.7753 11.8288 14.507C11.8288 12.2388 9.8518 10.4 7.4131 10.4C4.9744 10.4 2.99744 12.2388 2.99744 14.507C2.99744 16.7753 4.9744 18.6141 7.4131 18.6141Z"
                stroke="#585858"
                stroke-width="2"
              />
              <path
                d="M8.2697 27H1.27747C1.27746 26.2108 1.43608 25.4294 1.74424 24.7005C2.05239 23.9716 2.50403 23.3095 3.07328 22.7522C3.64253 22.1948 4.31821 21.7532 5.06163 21.4525C5.80505 21.1518 6.6016 20.9981 7.40566 21C8.40705 20.9987 9.39336 21.2395 10.2775 21.701"
                stroke="#585858"
                stroke-width="2"
              />
            </g>
            <defs>
              <clipPath id="clip0_3_25">
                <rect
                  width="37.6301"
                  height="35"
                  fill="white"
                  transform="translate(0.277466)"
                />
              </clipPath>
            </defs>
          </svg>
          Сообщества
        </li>
      </ul>
    </div>
    <div class="create_post">
      <form action="">
        <input
          type="text"
          v-model="text"
          @click="
            if (create_post == false) {
              create_post = true;
            } else {
              create_post = false;
            }
          "
          placeholder="Расскажите, что у вас нового!"
        />
        <div
          v-if="create_post == true"
          style="display: flex; flex-direction: column; gap: 10px"
        >
          <input
            multiple
            type="file"
            id="file"
            ref="file"
            required
            v-on:change="handleFileUpload()"
          />
          <button @click="addFiles()">Выбрать фото</button>
          <button @click.prevent="createPost()">Опубликовать</button>

          <div class="preview_photo">
            <div v-for="(photo, index) in url" :key="photo" id="preview">
              <img
                @click="url.splice(index, 1), removeFile(index)"
                v-if="url"
                :src="photo"
              />
            </div>
          </div>
        </div>

        <div v-if="message != ''" @click="message = ''" class="message">
          <p>{{ message }}</p>
        </div>
        <div v-if="error != ''" @click="error = ''" class="error">
          <p>{{ error }}</p>
        </div>
      </form>
      <div v-for="post in posts" :key="post" class="block post">
        <div class="header_post">
          <img :src="post.id_user.avatar" alt="" />
          <div>
            <p>{{ post.id_user.name }} {{ post.id_user.surname }}</p>
            <p>{{ getHumanDate(post.created_at) }}</p>
          </div>
        </div>
        <div class="body_post">
          <p>
            {{ post.text }}
          </p>

          <Carousel>
            <Slide v-for="slide in post.photos" :key="slide">
              <img :src="slide.photo" alt="" />
            </Slide>

            <template #addons>
              <Navigation />
              <Pagination />
            </template>
          </Carousel>
        </div>
        <div class="footer_post">
          <div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="34"
              height="40"
              viewBox="0 0 34 40"
              fill="none"
            >
              <path
                d="M11.6042 10V12.5C10.1687 12.5 8.99999 13.9013 8.99999 15.625H6.91666C6.91666 12.5238 9.01978 10 11.6042 10Z"
                fill="#AF3131"
              />
              <path
                d="M23.0032 6.25C20.8058 6.25 18.7528 7.33123 17.2917 9.20282C15.8305 7.33123 13.7775 6.25 11.5801 6.25C7.28504 6.25 3.79166 10.3405 3.79166 15.4545C3.79166 26.5515 17.2917 33.25 17.2917 33.25C17.2917 33.25 30.7917 26.5515 30.7917 15.4545C30.7917 10.3405 27.2983 6.25 23.0032 6.25ZM17.2917 30.5463C14.5688 28.9803 5.86858 23.3557 5.86858 15.4545C5.86858 11.7322 8.43046 8.70455 11.5801 8.70455C13.1897 8.70455 14.6768 9.47282 15.7651 10.867L16.5284 11.8451H18.0549L18.8182 10.867C19.9065 9.47282 21.3936 8.70455 23.0032 8.70455C26.1528 8.70455 28.7147 11.7322 28.7147 15.4545C28.7147 23.3557 20.0145 28.9803 17.2917 30.5463Z"
                fill="#AF3131"
              />
            </svg>
            <p>4</p>
          </div>
          <div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="29"
              height="33"
              viewBox="0 0 29 33"
              fill="none"
            >
              <g clip-path="url(#clip0_6_51)">
                <path
                  d="M14.9323 2.0625C7.36981 2.0625 0.666687 7.425 0.666687 13.6125C0.666687 17.7375 2.55731 21.2437 5.82294 23.3062V23.5125C5.65106 26.1937 4.27606 27.0188 4.27606 27.0188L1.18231 28.875H4.61981C8.91669 28.875 12.0104 26.6063 13.3854 24.9563C13.9011 24.9563 14.2448 24.9563 14.7604 24.9563C22.1511 24.9563 28.1667 19.8 28.1667 13.4062C28.1667 7.0125 22.3229 2.0625 14.9323 2.0625ZM14.7604 22.8938C14.2448 22.8938 13.5573 22.8938 13.2136 22.8938H12.6979L12.3542 23.3062C11.4948 24.3375 9.60419 26.1938 6.68231 26.8125C7.19794 25.7812 7.54169 24.5438 7.54169 22.6875V22.0688L7.02606 21.8625C3.93231 20.0063 2.38544 17.1187 2.38544 13.6125C2.38544 8.6625 8.40106 4.125 14.9323 4.125C21.2917 4.125 26.4479 8.25 26.4479 13.6125C26.4479 18.5625 21.1198 22.8938 14.7604 22.8938Z"
                  fill="#AF3131"
                />
              </g>
              <defs>
                <clipPath id="clip0_6_51">
                  <rect
                    width="27.5"
                    height="33"
                    fill="white"
                    transform="translate(0.666687)"
                  />
                </clipPath>
              </defs>
            </svg>
            <p>4</p>
          </div>
        </div>
      </div>
    </div>
    <div class="block weather">Потом сделаю</div>
  </div>
</template>

<script>
import moment from "moment/min/moment-with-locales";
moment.locale("ru");

import "vue3-carousel/dist/carousel.css";
import { Carousel, Slide, Pagination, Navigation } from "vue3-carousel";
import CarouselFixComponentVue from "../components/CarouselFixComponent.vue";
import PreviewPhotoVue from "../components/PreviewPhoto.vue";

export default {
  components: {
    Carousel,
    Slide,
    Pagination,
    Navigation,
    CarouselFixComponentVue,
    PreviewPhotoVue,
  },
  data() {
    return {
      create_post: false,
      text: "",
      message: "",
      error: "",
      posts: [],
      files: [],
      url: [],
    };
  },
  mounted() {
    document.title = "Новости";
    this.allPosts();
  },
  methods: {
    removeFile(key) {
      this.files.splice(key, 1);
    },
    addFiles() {
      this.$refs.file.click();
    },
    handleFileUpload() {
      let uploadedFiles = this.$refs.file.files;

      for (var i = 0; i < uploadedFiles.length; i++) {
        this.files.push(uploadedFiles[i]);
      }
      const preview = this.$refs.file.files;
      for (let index = 0; index < preview.length; index++) {
        this.url.push(URL.createObjectURL(preview[index]));
      }
      console.log(this.file, this.url);
    },
    getHumanDate: function (date) {
      return moment(date).fromNow();
    },
    allPosts() {
      axios
        .get("/api/post/all", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        })
        .then((res) => {
          this.posts = res.data.content;
        });
    },
    createPost() {
      let fd = new FormData();
      fd.set("text", this.text);
      for (let index = 0; index < this.files.length; index++) {
        fd.append("file[]", this.files[index]);
      }
      axios
        .post("/api/post/create", fd, {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        })
        .then((res) => {
          this.text = "";
          this.message = res.data.message;
          this.create_post = false;
          this.files = [];
          this.url = [];
          this.allPosts();
        })
        .catch((err) => {
          this.error = err.message;
        });
    },
  },
};
</script>

<style lang="scss" scoped>
.preview_photo {
  display: flex;
  flex-wrap: wrap;
  #preview img {
    max-width: 400px;
    max-height: 300px;
  }
}

.all_menu {
  display: flex;
  flex-direction: row;
  gap: 20px;
  width: 100%;
  .block:nth-child(1) {
    padding: 20px 0;
  }
  .menu {
    width: 20%;
    height: auto;
    ul {
      display: flex;
      flex-direction: column;
      gap: 20px;
      li {
        border-bottom: 2px solid #585858;
        padding-bottom: 10px;
        padding-left: 20px;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
      }
      li:hover {
        border-bottom: 2px solid #af3131;
        cursor: pointer;
        svg {
          path {
            stroke: #af3131;
          }
        }
      }
      li:last-child {
        border: none;
        padding-bottom: 0;
      }
    }
  }
  .create_post {
    width: 60%;
    height: auto;
    margin-top: 20px;
    height: 40px;
    form {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      input {
        width: 100%;
        background: transparent;
        border: 2px solid #af3131;
        height: 40px;
        border-radius: 10px;
        padding-left: 5px;
      }
      input[type="file"] {
        width: auto;
        position: absolute;
        top: -500px;
      }
      div {
        button {
          cursor: pointer;
          background: transparent;
          padding: 5px 25px;
          border: 2px solid #af3131;
          border-radius: 10px;
        }
      }
    }
  }
  .weather {
    width: 20%;
    height: auto;
  }
}
.post {
  .header_post {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 10px;
    div {
      display: flex;
      flex-direction: column;
      gap: 10px;
      p:nth-child(1) {
        font-size: 15px;
      }
      p:nth-child(2) {
        color: #606060;
        font-size: 13px;
      }
    }
    img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
    }
  }
  .body_post {
    margin-top: 20px;
    img {
      margin-top: 20px;
      max-width: 100%;
    }
  }
  .footer_post {
    margin-top: 20px;
    display: flex;
    flex-direction: row;
    gap: 20px;
    div {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 5px;
      svg {
        cursor: pointer;
      }
      p {
        color: #af3131;
      }
    }
  }
}
.message {
  cursor: pointer;
  background: #155f0b;
  padding: 10px 25px;
  border-radius: 10px;
}
.error {
  cursor: pointer;
  background: #5f0b0b;
  padding: 10px 25px;
  border-radius: 10px;
}
</style>